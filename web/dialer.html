<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Dialer with TTS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .call-status-badge {
            transition: all 0.3s ease;
        }
        
        .animate-ping {
            animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        
        @keyframes ping {
            75%, 100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }
        
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-4">
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-phone-alt text-blue-600 mr-3"></i>
                Voice Dialer with TTS
            </h1>
            <p class="text-gray-600 mt-2">Make calls and play TTS messages using cloned voices</p>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Dialer Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">New Call</h2>
                    
                    <form id="dialerForm" class="space-y-4">
                        <!-- Call Settings -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="callerID" class="block text-sm font-medium text-gray-700 mb-1">Caller ID</label>
                                <input type="text" id="callerID" name="callerID" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., +923001234567">
                            </div>
                            <div>
                                <label for="destination" class="block text-sm font-medium text-gray-700 mb-1">Destination Number</label>
                                <input type="text" id="destination" name="destination" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., +923009876543">
                            </div>
                        </div>
                        
                        <div>
                            <label for="sipName" class="block text-sm font-medium text-gray-700 mb-1">SIP Agent Name</label>
                            <select id="sipName" name="sipName" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select Agent</option>
                                <!-- These will be populated dynamically -->
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        
                        <!-- TTS Message -->
                        <div>
                            <label for="ttsMessage" class="block text-sm font-medium text-gray-700 mb-1">TTS Message</label>
                            <textarea id="ttsMessage" name="ttsMessage" rows="4" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Enter the message to be converted to speech..."></textarea>
                        </div>
                        
                        <!-- Voice Selection -->
                        <div>
                            <label for="voiceSelect" class="block text-sm font-medium text-gray-700 mb-1">Voice</label>
                            <select id="voiceSelect" name="voiceSelect" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select Voice</option>
                                <!-- These will be populated dynamically -->
                            </select>
                        </div>
                        
                <!-- Preview Button -->
                        <div class="flex justify-end space-x-2">
                            <button type="button" id="previewButton" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 inline-flex items-center">
                                <i class="fas fa-play mr-2"></i> Preview
                            </button>
                            <button type="button" id="saveForCallButton" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-green-400 inline-flex items-center hidden">
                                <i class="fas fa-save mr-2"></i> Use in Call
                            </button>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="pt-4 border-t border-gray-200">
                            <button type="submit" id="dialButton" class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-phone mr-2"></i> Start Call
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Audio Preview Section (hidden by default) -->
                <div id="audioPreview" class="mt-6 bg-white rounded-lg shadow-md p-6 hidden">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Preview TTS</h3>
                    <div class="mb-4">
                        <audio id="audioPlayer" controls class="w-full">
                            <source id="audioSource" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>
            </div>
            
            <!-- Active Call Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Active Call</h2>
                        <span id="callDuration" class="text-gray-600 font-mono">00:00</span>
                    </div>
                    
                    <!-- Call Status -->
                    <div id="callStatus" class="mb-6 text-center p-4 bg-gray-100 rounded-lg">
                        <span class="text-gray-500">No active call</span>
                    </div>
                    
                    <!-- Call Details -->
                    <div id="callDetails" class="space-y-3 mb-6 hidden">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">To:</span>
                            <span id="callDestination" class="text-sm font-medium text-gray-800"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Agent:</span>
                            <span id="callAgent" class="text-sm font-medium text-gray-800"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Voice:</span>
                            <span id="callVoice" class="text-sm font-medium text-gray-800"></span>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <div class="text-sm text-gray-600 mb-1">Message:</div>
                            <div id="callMessage" class="text-sm text-gray-800 bg-gray-50 p-2 rounded"></div>
                        </div>
                    </div>
                    
                    <!-- Call Controls -->
                    <div id="callControls" class="grid grid-cols-2 gap-3 hidden">
                        <button id="playTtsButton" class="flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i class="fas fa-play mr-2"></i> Play TTS
                        </button>
                        <button id="hangupButton" class="flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i class="fas fa-phone-slash mr-2"></i> Hangup
                        </button>
                    </div>
                    
                    <!-- Recent Calls List -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">Recent Calls</h3>
                        <ul id="recentCalls" class="space-y-2 overflow-auto max-h-64">
                            <!-- This will be populated dynamically -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const API_BASE_URL = window.location.origin;
        const REFRESH_INTERVAL = 5000; // 5 seconds
        
        // Global variables
        let activeCallId = null;
        let callTimer = null;
        let callStartTime = null;
        let ttsAudioBlob = null;
        let ttsAudioUrl = null;
        let ttsAudioId = null; // ID of the pre-generated TTS file
        let voices = [];
        let agents = [];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadVoices();
            loadAgents();
            loadRecentCalls();
            
            // Start periodic refresh for call status
            setInterval(updateCallStatus, REFRESH_INTERVAL);
        });
        
        // Initialize event listeners
        function initializeEventListeners() {
            // Form submission
            document.getElementById('dialerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                startCall();
            });
            
            // Preview button
            document.getElementById('previewButton').addEventListener('click', previewTTS);
            
            // Save for call button
            document.getElementById('saveForCallButton').addEventListener('click', saveForCall);
            
            // Call controls
            document.getElementById('playTtsButton').addEventListener('click', playTTS);
            document.getElementById('hangupButton').addEventListener('click', hangupCall);
        }
        
        // Load available voices
        function loadVoices() {
            fetch(`${API_BASE_URL}/api/voices`)
                .then(response => response.json())
                .then(data => {
                    voices = data.voices || [];
                    const voiceSelect = document.getElementById('voiceSelect');
                    
                    // Clear existing options
                    while (voiceSelect.options.length > 1) {
                        voiceSelect.remove(1);
                    }
                    
                    // Add voices
                    voices.forEach(voice => {
                        if (voice.status === 'ready' || voice.status === 'active') {
                            const option = document.createElement('option');
                            option.value = voice.name;
                            option.textContent = voice.name;
                            voiceSelect.appendChild(option);
                        }
                    });
                    
                    // Select active voice if any
                    if (data.activeVoice) {
                        voiceSelect.value = data.activeVoice;
                    }
                })
                .catch(error => {
                    console.error('Failed to load voices:', error);
                    showNotification('Failed to load voices', 'error');
                });
        }
        
        // Load available SIP agents
        function loadAgents() {
            // This would typically fetch from your backend
            // For now, we'll use the static list in the HTML
            
            // Example of how you would implement this:
            /*
            fetch(`${API_BASE_URL}/api/sip/agents`)
                .then(response => response.json())
                .then(data => {
                    agents = data.agents || [];
                    const sipSelect = document.getElementById('sipName');
                    
                    // Clear existing options
                    while (sipSelect.options.length > 1) {
                        sipSelect.remove(1);
                    }
                    
                    // Add agents
                    agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.name;
                        option.textContent = agent.displayName || agent.name;
                        sipSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Failed to load agents:', error);
                    showNotification('Failed to load SIP agents', 'error');
                });
            */
        }
        
        // Load recent calls
        function loadRecentCalls() {
            fetch(`${API_BASE_URL}/api/calls/recent`)
                .then(response => response.json())
                .then(data => {
                    const recentCalls = document.getElementById('recentCalls');
                    recentCalls.innerHTML = '';
                    
                    if (data.calls && data.calls.length > 0) {
                        data.calls.forEach(call => {
                            const callItem = document.createElement('li');
                            callItem.className = 'bg-gray-50 p-2 rounded-md text-sm';
                            
                            const timestamp = new Date(call.timestamp).toLocaleTimeString();
                            const status = getCallStatusBadge(call.status);
                            
                            callItem.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-medium">${call.destination}</div>
                                        <div class="text-xs text-gray-500">${timestamp}</div>
                                    </div>
                                    <div>${status}</div>
                                </div>
                            `;
                            
                            // Add click handler to reload the call
                            callItem.addEventListener('click', () => {
                                loadCallDetails(call.id);
                            });
                            
                            recentCalls.appendChild(callItem);
                        });
                    } else {
                        recentCalls.innerHTML = '<li class="text-center text-gray-500 py-2">No recent calls</li>';
                    }
                })
                .catch(error => {
                    console.error('Failed to load recent calls:', error);
                });
        }
        
        // Get call status badge HTML
        function getCallStatusBadge(status) {
            const statusColors = {
                'initiated': 'bg-yellow-100 text-yellow-800',
                'dialing': 'bg-blue-100 text-blue-800',
                'connected': 'bg-green-100 text-green-800',
                'completed': 'bg-gray-100 text-gray-800',
                'failed': 'bg-red-100 text-red-800'
            };
            
            const color = statusColors[status] || 'bg-gray-100 text-gray-800';
            return `<span class="px-2 py-1 rounded-full text-xs ${color}">${status}</span>`;
        }
        
        // Preview TTS
        function previewTTS() {
            const text = document.getElementById('ttsMessage').value.trim();
            const voice = document.getElementById('voiceSelect').value;
            
            if (!text) {
                showNotification('Please enter a message', 'error');
                return;
            }
            
            if (!voice) {
                showNotification('Please select a voice', 'error');
                return;
            }
            
            // Update button state
            const previewButton = document.getElementById('previewButton');
            const originalText = previewButton.innerHTML;
            previewButton.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Generating...';
            previewButton.disabled = true;
            
            // Hide the saveForCall button during generation
            document.getElementById('saveForCallButton').classList.add('hidden');
            
            // Call TTS API
            fetch(`${API_BASE_URL}/api/synthesize`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    voice: voice
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate TTS');
                }
                return response.blob();
            })
            .then(blob => {
                // Store the blob for later use
                ttsAudioBlob = blob;
                ttsAudioUrl = URL.createObjectURL(blob);
                
                // Update audio player
                const audioPlayer = document.getElementById('audioPlayer');
                const audioSource = document.getElementById('audioSource');
                audioSource.src = ttsAudioUrl;
                audioPlayer.load();
                
                // Show preview section
                document.getElementById('audioPreview').classList.remove('hidden');
                
                // Show the saveForCall button
                document.getElementById('saveForCallButton').classList.remove('hidden');
                
                // Auto-play
                audioPlayer.play();
            })
            .catch(error => {
                console.error('Failed to preview TTS:', error);
                showNotification('Failed to generate TTS preview', 'error');
            })
            .finally(() => {
                // Reset button state
                previewButton.innerHTML = originalText;
                previewButton.disabled = false;
            });
        }
        
        // Save TTS for use in call
        function saveForCall() {
            if (!ttsAudioBlob) {
                showNotification('No TTS audio to save', 'error');
                return;
            }
            
            // Update button state
            const saveButton = document.getElementById('saveForCallButton');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Saving...';
            saveButton.disabled = true;
            
            // Create FormData and append the audio blob
            const formData = new FormData();
            formData.append('audio', ttsAudioBlob, 'tts-audio.wav');
            formData.append('text', document.getElementById('ttsMessage').value);
            formData.append('voice', document.getElementById('voiceSelect').value);
            
            // Send to server to save
            fetch(`${API_BASE_URL}/api/tts/save-for-call`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('TTS saved for call usage', 'success');
                    
                    // Store the TTS file ID for later use
                    ttsAudioId = data.file_id;
                    
                    // Update the save button to show it's ready
                    saveButton.innerHTML = '<i class="fas fa-check mr-2"></i> Ready for Call';
                    saveButton.className = 'px-3 py-1 bg-green-200 text-green-800 rounded hover:bg-green-300 focus:outline-none focus:ring-2 focus:ring-green-400 inline-flex items-center';
                } else {
                    throw new Error(data.message || 'Failed to save TTS');
                }
            })
            .catch(error => {
                console.error('Failed to save TTS for call:', error);
                showNotification('Failed to save TTS: ' + error.message, 'error');
                
                // Reset button state
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            });
        }
        
        // Start a new call
        function startCall() {
            const callerId = document.getElementById('callerID').value;
            const destination = document.getElementById('destination').value;
            const sipName = document.getElementById('sipName').value;
            const message = document.getElementById('ttsMessage').value;
            const voice = document.getElementById('voiceSelect').value;
            
            if (!destination || !sipName || !message || !voice) {
                showNotification('Please fill all required fields', 'error');
                return;
            }
            
            // Check if TTS has been saved for call
            if (!ttsAudioId) {
                showNotification('Please preview and save TTS for call first', 'warning');
                return;
            }
            
            // Disable the dial button
            const dialButton = document.getElementById('dialButton');
            dialButton.disabled = true;
            dialButton.classList.add('btn-disabled');
            dialButton.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Initiating Call...';
            
            // Prepare the call request
            const callRequest = {
                caller_id: callerId,
                destination: destination,
                sip_name: sipName,
                message: message,
                voice: voice,
                tts_file_id: ttsAudioId  // Include the pre-generated TTS file ID
            };
            
            // Send the request to initiate the call
            fetch(`${API_BASE_URL}/api/calls/initiate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(callRequest),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Call initiated successfully', 'success');
                    
                    // Store the call ID and update the UI
                    activeCallId = data.call_id;
                    updateCallUI(data.call);
                    
                    // Start the call timer
                    startCallTimer();
                    
                    // Refresh recent calls
                    loadRecentCalls();
                } else {
                    throw new Error(data.message || 'Failed to initiate call');
                }
            })
            .catch(error => {
                console.error('Failed to initiate call:', error);
                showNotification('Failed to initiate call: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset button state
                dialButton.disabled = false;
                dialButton.classList.remove('btn-disabled');
                dialButton.innerHTML = '<i class="fas fa-phone mr-2"></i> Start Call';
            });
        }
        
        // Update call status periodically
        function updateCallStatus() {
            if (!activeCallId) return;
            
            fetch(`${API_BASE_URL}/api/calls/${activeCallId}/status`)
                .then(response => response.json())
                .then(data => {
                    updateCallUI(data.call);
                    
                    // If call is completed or failed, stop the timer
                    if (data.call.status === 'completed' || data.call.status === 'failed') {
                        stopCallTimer();
                        activeCallId = null;
                        
                        // Refresh recent calls
                        loadRecentCalls();
                    }
                })
                .catch(error => {
                    console.error('Failed to update call status:', error);
                });
        }
        
        // Update the UI with call details
        function updateCallUI(call) {
            const callStatus = document.getElementById('callStatus');
            const callDetails = document.getElementById('callDetails');
            const callControls = document.getElementById('callControls');
            
            // Update call status
            callStatus.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="relative">
                        <span class="inline-flex h-3 w-3 rounded-full ${call.status === 'connected' ? 'bg-green-500' : 'bg-yellow-500'}"></span>
                        ${call.status === 'dialing' || call.status === 'initiated' ? 
                            '<span class="absolute inline-flex h-3 w-3 rounded-full bg-yellow-400 opacity-75 animate-ping"></span>' : ''}
                    </div>
                    <span class="mt-2 font-medium ${call.status === 'connected' ? 'text-green-600' : call.status === 'failed' ? 'text-red-600' : 'text-yellow-600'}">
                        ${call.status.charAt(0).toUpperCase() + call.status.slice(1)}
                    </span>
                </div>
            `;
            
            // Update call details
            document.getElementById('callDestination').textContent = call.destination;
            document.getElementById('callAgent').textContent = call.sip_name;
            document.getElementById('callVoice').textContent = call.voice;
            document.getElementById('callMessage').textContent = call.message;
            
            // Show details and controls
            callDetails.classList.remove('hidden');
            
            // Only show controls if call is connected
            if (call.status === 'connected') {
                callControls.classList.remove('hidden');
                document.getElementById('playTtsButton').disabled = false;
                document.getElementById('playTtsButton').classList.remove('btn-disabled');
            } else if (call.status === 'completed' || call.status === 'failed') {
                callControls.classList.add('hidden');
            } else {
                callControls.classList.remove('hidden');
                document.getElementById('playTtsButton').disabled = true;
                document.getElementById('playTtsButton').classList.add('btn-disabled');
            }
        }
        
        // Load call details
        function loadCallDetails(callId) {
            fetch(`${API_BASE_URL}/api/calls/${callId}`)
                .then(response => response.json())
                .then(data => {
                    // If call is still active, update the active call
                    if (data.call.status !== 'completed' && data.call.status !== 'failed') {
                        activeCallId = callId;
                        startCallTimer(data.call.start_time);
                    }
                    
                    // Update the UI
                    updateCallUI(data.call);
                    
                    // Pre-fill the form with call details for potential retry
                    document.getElementById('callerID').value = data.call.caller_id || '';
                    document.getElementById('destination').value = data.call.destination;
                    document.getElementById('sipName').value = data.call.sip_name;
                    document.getElementById('ttsMessage').value = data.call.message;
                    document.getElementById('voiceSelect').value = data.call.voice;
                })
                .catch(error => {
                    console.error('Failed to load call details:', error);
                    showNotification('Failed to load call details', 'error');
                });
        }
        
        // Play TTS in the active call
        function playTTS() {
            if (!activeCallId) {
                showNotification('No active call', 'error');
                return;
            }
            
            // Update button state
            const playButton = document.getElementById('playTtsButton');
            const originalText = playButton.innerHTML;
            playButton.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Playing...';
            playButton.disabled = true;
            
            // Send request to play TTS
            fetch(`${API_BASE_URL}/api/calls/${activeCallId}/play-tts`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('TTS playing in call', 'success');
                } else {
                    throw new Error(data.message || 'Failed to play TTS');
                }
            })
            .catch(error => {
                console.error('Failed to play TTS:', error);
                showNotification('Failed to play TTS: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset button state after a delay to simulate playing
                setTimeout(() => {
                    playButton.innerHTML = originalText;
                    playButton.disabled = false;
                }, 3000);
            });
        }
        
        // Hangup the active call
        function hangupCall() {
            if (!activeCallId) {
                showNotification('No active call', 'error');
                return;
            }
            
            // Update button state
            const hangupButton = document.getElementById('hangupButton');
            hangupButton.disabled = true;
            
            // Send request to hangup
            fetch(`${API_BASE_URL}/api/calls/${activeCallId}/hangup`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Call ended', 'success');
                    
                    // Stop the timer and reset active call
                    stopCallTimer();
                    activeCallId = null;
                    
                    // Update UI
                    const callStatus = document.getElementById('callStatus');
                    callStatus.innerHTML = '<span class="text-gray-500">No active call</span>';
                    
                    document.getElementById('callDetails').classList.add('hidden');
                    document.getElementById('callControls').classList.add('hidden');
                    
                    // Refresh recent calls
                    loadRecentCalls();
                } else {
                    throw new Error(data.message || 'Failed to hangup call');
                }
            })
            .catch(error => {
                console.error('Failed to hangup call:', error);
                showNotification('Failed to hangup call: ' + error.message, 'error');
                
                // Reset button state
                hangupButton.disabled = false;
            });
        }
        
        // Start call timer
        function startCallTimer(startTime) {
            // Stop any existing timer
            stopCallTimer();
            
            // Set start time
            callStartTime = startTime ? new Date(startTime) : new Date();
            
            // Start the timer
            callTimer = setInterval(updateCallDuration, 1000);
            updateCallDuration(); // Update immediately
        }
        
        // Stop call timer
        function stopCallTimer() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
        }
        
        // Update call duration display
        function updateCallDuration() {
            if (!callStartTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - callStartTime) / 1000);
            
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            
            document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>